Multi-channel Registration for Diffusion MRI: Longitudinal Analysis for the Neonatal Brain
Alena Uus, Maximilian Pietsch, Irina Grigorescu, Daan Christiaens, Jacques-Donald Tournier, Lucilio Cordero Grande, Jana Hutter, David Edwards, Joseph Hajnal, Maria Deprez
In multi-channel (MC) registration, fusion of structural and diffusion brain MRI provides information on both cortex and white matter (WM) structures thus decreasing the uncertainty of deformation fields. However, the existing solutions employ only diffusion tensor imaging (DTI) derived metrics which are limited by inconsistencies in fiber-crossing regions. In this work, we extend the pipeline for registration of multi-shell high angular resolution diffusion imaging (HARDI)
The combined analysis of diffusion and structural MRI is extensively used in adult and neonatal [20] brain studies. Structural MRI has the highest contrast for the cortex region, while dMRI primarily provides information about white matter (WM) structures. The uncertainty of deformation fields in the regions characterised by low contrast or homogeneous intensities (e.g., low WM fibre density regions in dMRI) is one the primary challenges associated with both longitudinal and inter-subject registration. Multi-channel registration that includes both anatomical and diffusion channels has been shown to improve registration and label-propagation results [2, 7, 19] . The reported MC registration solutions generally employ fractional anisotropy (FA) [7, 8, 14, 19] or DTI [2, 9, 13] as an additional channel. However, DTI-extracted metrics are characterised by inconsistencies in fibrecrossing regions. On the other hand, higher-order techniques such as constrained spherical deconvolution (CSD) [21] alleviate some of the limitations of the DTI model and allow extracting orientation-resolved microstructural information as so-called orientation distribution functions (ODFs) from HARDI data. The classical approach for the fusion of information from different channels is based on simple averaging of individual channel updates [2] . More recently proposed solutions include scalar weighs for ROIs defined by thresholded FA maps [13] or local certainty maps based on normalised gradients correlated to structural content [7] . While the detailed overview of the choice of registration metrics is out-of-scope of this work, it can be summarised that the published works on intensity-based multi-channel registration primarily use the sum of squared differences (SSD) [2, 7, 8, 14] or local normalised cross-correlation (LNCC) [4] metrics. There is also a reported approach for T1-DTI atlas generation where datasets are spatially normalized only according to the structural channel [9] . Contributions. In this work we present a framework for multi-channel brain registration that allows local certainty-based fusion of dMRI-derived ODFs and structural MRI and is based on a novel similarity metric for dMRI. The solution is an extension of the multi-contrast ODF registration framework [15, 17] . The novel elements include implementation of local angular correlation (AC) as a metric for ODF channels, LNCC for structural channels and weighted fusion based on local certainty maps. The pipeline was implemented in MRtrix3 [22] . The method is evaluated on 20 longitudinal (intra-patient) neonatal MRI datasets from the developing Human Connectome Project (dHCP) 1 which constitutes a particularly challenging task for registration due to the rapid changes that occur in volume, structure and intensities during brain development. In addition, we demonstrate an example of a MC template of neonatal brain generated from 10 datasets (40-43 weeks PMA) using the proposed registration approach. The data used for evaluation of the proposed method include 20 longitudinal datasets of neonates scanned as a part of the dHCP project at St. Thomas Hospital, London. The gap between the scans is in the range of 7-11 weeks which is associated with significant changes in volume, myelination and cortical folding [16] . The postmenstrual age (PMA) at the first scan is within 30-35 weeks. Each dataset includes two scans with diffusion and structural MRI volumes acquired on a Philips 3T scanner. The multi-shell HARDI volumes were acquired with four phase-encode directions on four shells with b-values of 0, 400, 1000 and 2600 s/mm 2 with TE 90 ms, TR 3800 ms [10] with 1.5?1.5?3 mm resolution and 1.5 mm slice overlap and reconstructed to 1.5 mm isotropic resolution using the SHARD pipeline [5] . The structural T2-weighted volumes were acquired using a TSE sequence with TR = 12 s, TE = 156 ms. The T1-weighted volumes were acquired using an IR TSE sequence with TR 4.8 s, TE 8.7 ms. The isotropic T2 and T1 volumes with 0.5 mm resolution were reconstructed using a combination of motion correction [6] and super-resolution reconstruction [11] . All volumes of the same modality were normalised to the same global intensity ranges. The tissue segmentations were generated by the Draw-EM pipeline [12] . The preprocessing of the datasets was performed in MRtrix3 including: (i) decomposition of WM ODF from HARDI data via constrained spherical deconvolution (CSD) [21] followed by intensity normalisation; (ii) extraction of FA and mean diffusivity (MD) DTI-metrics; (iii) alignment of the structural to dMRI volumes based on affine registration of T2 to MD volumes using global NCC metric; (iv) resampling of all channels to 1 mm isotropic resolution with B-Spline interpolation. In addition, we manually segmented internal capsules (IC) in FA volumes for all datasets. The proposed registration pipeline is an extension of the multi-contrast ODF registration framework [15, 17] . The original method is based on SyN Demons [2] with an SSD metric and reorientation of ODF using apodized point spread functions [18] . In order to decrease the sensitivity to acquisition or physiology related changes in signal intensities, we replace SSD with a novel similarity metric based on angular correlation [1] and add certainty-maps weighting for fusion of structural and diffusion channels. The input channels for each of the cases include: WM ODFs, structural MRI (T2-weighted and T1-weighted) volumes and FA maps. At first, the cases are globally aligned using affine registration of structural volumes using the global NCC metric. Next, we employ symmetric diffeomorphic LNCC demons [3] for structural and FA channels and local angular correlation metric [1] for ODF channels. In comparison to the classical ODF registration approach based on SSD metric in [15] , using AC provides a more robust solution since it is less susceptible to the local changes in signal intensities while preserving directional information. However, unlike SSD, AC might be affected by the noise in the directional information. Angular correlation r A between two ODFs F ODF and G ODF represented with real valued spherical harmonic (SH) orthonormal basis functions Y lm (è, ö) is computed as [1] : where g lm and f lm are the SH coefficients of G ODF (è, ö) and F ODF (è, ö) of order L with even l = {2, 4, ..., L} harmonic degree terms, correspondingly. The l = 0 term does not contribute to AC values. Since this is a correlation metric, the corresponding symmetric updates to the displacement fields Ë F and Ë G can be computed in a similar manner to LNCC demons [3] but with respect to the 4D ODFs rather than only the 3D local neighbourhood (Eq. 3). where G = {g n lm } l=2,...,lmax,m=?l,...,l and F = {f n lm } l=2,...,lmax,m=?l,...,l are the vectors of SH coefficients at a given location in the 3D volume space with local neighbourhood n = 1, ..., N . We refer to this registration metric as local angular cross-correlation (LAC). The updates from the structural channels are computed similarly to [3] . We also consider Y 00 (è, ö) as a separate channel and use the LNCC metric for its contributions since it is excluded from the AC metric formalisation (Eq. 2). The contributions from each of the channels i to the global symmetric displacement field update Ë global are locally weighted with respect to the 3D certainty maps based on the approach proposed in [7] . At first, the certainty maps á F i and á G i are computed from the original volumes F and G for each of the channels (including structural and ODF volumes) and normalised as: Then, the global symmetric updates to the displacement fields are computed by weighted averaging of the channel-specific update fields with respect to the certainty maps: Figure 1 shows an example of the certainty gradient maps á i for structural, FA and one of the ODF component channels and the i á i of all channels. This approach ensures that the output deformation fields are defined by the contribution of the local channel regions with the highest structural content. This is relevant for the ROIs where one of the channels has low intensity contrast. In comparison, the multi-variate SyN (MVSyN) approach [2] is based on averaging of the individual channel updates.  The method was implemented in MRtrix3 [22] . The new elements include: LAC metric for ODF registration and certainty-based weighting of the channels. In addition, we transferred ANTs 2 implementation of LNCC Demons metric [3] to MRtrix3 for registration of structural, Y 00 (è, ö) ODF and FA channels. It was experimentally identified that multi-resolution {0.5; 0.75; 1.0} and SH order l max = {0; 2; 4} schemes and 3 voxel radius for the local neighbourhood for both structural and ODF channels are optimal for deformable registration of the investigated datasets. We used the standard MRtrix3 regularisation of gradient update and displacement fields based on Gaussian smoothing with 1 voxel standard deviation. The MRtrix3 parameter settings employed for generation of the multi-channel template are based on the pipeline formalised in [16] . The MRtrix3-based implementation of LNCC Demons [3] is based on the ANTs toolbox and provides similar performance for structural registration. Therefore, we compare the proposed method directly to the existing MRtrix3 registration module. The main aim is an improvement of the combined quality of label propagation and image similarity for the structural and diffusion channels. Table 1 presents the results of the comparison study. The quantitative evaluation is performed with respect to the quality of label propagation (Dice score) and similarity of the registered ODF volumes. The labels include: cortical grey matter (C-GM), hippocampus (HIP) and internal capsule (IC). The intensitybased similarity is assessed in terms of ODF AC (Eq. 2) for l max = 4. The best performance results are highlighted in blue. Firstly we can observe that locally weighted fusion [7] of T2 and FA improves the combined results while slightly lowering the dice score for cortex compared to single channel T2. Table 1 . Quantitative evaluation of the proposed multi-channel registration approach on longitudinal dMRI datasets of 20 neonates: Dice coefficient for brain tissue labels and AC between ODF volumes. In general, myelination and cortical folding occurring during 7-11 weeks period significantly change local intensities in both structural and diffusion MRI data [16] . Therefore, even though all input volumes were normalised, using SSD metric for ODF or structural MC registration leads to the lower quality results in comparison to the proposed LAC metric which produced statistically significant (p < 0.05) improvement for C-GM and HIP Dice scores and ODF AC, while there was not a significant difference in Dice scores of IC. Figure 2 demonstrates an example of the original and transformed WM ODF SH coefficients (l = 2, m = 0) for longitudinal registration of 31 to 42 weeks PMA datasets. There is a clear difference in the magnitude of SH coefficients between the original scans. Using MC registration with LAC for ODF and LNCC for structural channels produces visually sharper results for the IC region in comparison to both classical SSD ODF registration [15, 17] or fusion of T2 and FA [7] . This is in agreement with the higher AC values reported in Table 1 . Furthermore, there is a clear indication that additional structural channels (in this case T1+T2) and certainty-based weighting increase the quality of label propagation and AC similarity of ODF volumes. Adding the FA channel did not significantly affect the results since ODFs contain the WM structure information. All ODF-based options resulted in approximately the same range for the IC Dice score values due to its high contrast and showed significant improvement (p < 0.05) in comparison to using the FA and T2 channels only. Apart from the IC values for ODF registration, the improvement in performance of the proposed method (ODF+STR: W-LAC/LNCC) in comparison to the baseline methods (structural LNCC Demons, ODF MRtrix registration as well as fused T2+FA) is statistically significant with p < 0.05. An example of symmetric LAC+LNCC MC registration for 31 ?? 42 weeks PMA at scan case is presented in Fig. 3 . The registration of the structural and ODF channels was successful even though there are significant differences in contrast of both structural and ODF volumes, cortex folding surface and the global shape. Visualisation of the original and transformed normalised ODFs over the same padded T1 volume (third row) confirms that the global shape and features of the volumes are sufficiently well aligned. Label propagation for tissue and IC segmentations also resulted in relatively similar results. This, however, might also be affected by the quality of the original segmentations produced by the automated Draw-EM method [12] . Figure 4 shows and example of a multi-channel template generated using MRtrix3 population template tool with the proposed MC registration pipeline and LAC+LNCC metrics. The template with 1 mm resolution was generated from 10 neonatal MRI datasets from 40-43 weeks PMA. It includes T2, T1, normalised WM ODF and FA channels. The resulting volumes are characterised by well defined features of both cortex and WM structures.  This paper presents a solution for multi-channel registration combining multishell HARDI and structural MRI data. It is based on a novel similarity metric for diffusion MRI and certainty-based weighting of the channels. The method was implemented in MRtrix3 and can be integrated into neuroimaging pipelines. The quantitative evaluation was performed on 20 longitudinal neonatal datasets from the dHCP project. The results showed that fusion of structural and diffusion ODF channels improves overall results, compared to single-channel registrations. The weighting of channels based on certainty maps also improves the results thus potentially minimising the uncertainty of deformation fields. Furthermore, the proposed LAC metric outperforms the state-of-the-art ODF registration method for challenging cases. An example of the generated multi-modal template shows that this tool has a potential application for generation of spatio-temporal multi-modal brain MRI templates that require robust similarity metrics. Simultaneous segmentation of WM and cortex structures could also potentially improve the accuracy of morphometry in structural MRI processing pipelines. However, these results also emphasise the fact that accurate alignment of diffusion and structural volumes is a critical step for multi-channel registration since affine registration might not fully solve this due to distortions in dMRI data. Future work will focus on further optimisation of the MC ODF registration pipeline and extensive evaluation on adult and multi-site datasets. 